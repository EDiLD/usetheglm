---
title: "Use the GLM, Luke."
author: "Eduard Sz√∂cs"
date: "20/08/2014"
output: pdf_document
---

# Introduction
## Generalized Linear Models


# Methods
```{r setup, echo=FALSE, message=FALSE}
require(plyr)
require(reshape2)
require(ggplot2)
require(MASS)
```

```{r simulations, echo=FALSE}
N <- c(3,6,9,12)
ctrl <- exp(log(10) * seq(log10(1), log10(1000), by=0.25))
todo <- expand.grid(N = N, ctrl = ctrl)
nsims <- 100

dosim <- function(N = N, mu = mu, nsims = 100){
  Nj     <- rep(N, 6)                   # number of replictas per group
  mu     <- mu                            # expected values in groups
  theta  <- rep(3.91, 6)                            # theta in groups
  mus    <- rep(mu, times = Nj)             # vector of mus
  thetas <- rep(theta, times=Nj)            # vector of thetas
  x      <- factor(rep(1:6, times=Nj))       # factor
  y      <- replicate(nsims, rnegbin(sum(Nj), mus, thetas))
  return(list(x = x, y = y))
}
sims <- NULL
for(i in seq_len(nrow(todo))){
  N <- todo[i, 'N']
  takectrl <- todo[i, 'ctrl']
  # treatment = 50% reduction in abundance
  taketrt <-takectrl * 0.5
  # LOEC = 3rd, NOEC 2sn concentration
  mu <- c(rep(takectrl, each = 2), rep(taketrt, each = 4))
  sims[[i]] <- dosim(N = N, mu = mu)
}

```

## Simulation scenarious

We simulated 6 groups (1 control + 5 treatments (T1 - T5)) of equal sample sizes.
Control and T1 had the same mean, whereas T2-T4 were simulated to have a mean half of control. 
Therefore, the LOEC is T2 and NOEC T2.
Data sets were simulated from a negative binomial distribution, with the dispersion parameter of 3.91 for all groups.
Figure xxx shows one realisation of such a simulation.
To explore the power properties we varied the sample size (N = {3, 6, 9, 12}) and the abundances 
muc = {1.0, 1.8, 3.2, 5.6, 10.0, 17.8, 31.6, 56.2, 100.0, 177.8,  316.2,  562.3, 1000.0}.

```{r echo=FALSE, message=FALSE,fig.cap='A simulated data set (N = 12, mc = 316)'}
df <- data.frame(x = sims[[44]]$x, y = sims[[44]]$y[,1])
df$yt <- log(1/min(df$y[df$y!=0]) * df$y + 1)
dfm <- melt(df)
ggplot(dfm, aes(x = x, y = value)) +
  geom_boxplot(fill = 'grey80') +
  facet_wrap(~variable, scales = 'free_y') +
  theme_bw() +
  scale_x_discrete(labels = c('Control', 'T1', 'T2', 'T3', 'T4', 'T5'))
```

Different models were fitted using the two approaches:

1. A linear model, after a ln(A*x + 1) transformation
2) A GLM with negative binomial distribution



## Simulations based on real data


# Results
## Simulation scenarious results
```{r results, echo=FALSE}
res <- readRDS('/home/edisz/Downloads/donotlog/res.rds')
```


```{r, echo=FALSE}
# extract information
# global power
pow <- function(z){
  ps <- ldply(z, function(w) c(lm = w$plm, glm = w$pglm))
  apply(ps, 2, function(z) sum(z < 0.05)) / nsims
}
pows <- ldply(res, pow)
pows$muc <- todo$ctrl
pows$N <- todo$N

# require(rgl)
# wireframe(lm ~ N + muc, data = pows,
#           screen = list(z = 30, x = -60))

powsm <- melt(pows, id.vars = c('muc', 'N'))
ggplot(powsm) +
  geom_line(aes(y = value, x = muc, col = variable)) +
  coord_trans(xtrans = 'log10') +
  scale_x_continuous(breaks = round(ctrl, 0)) +
  facet_wrap(~N) + 
  theme_bw() +
  labs(x = 'mean Abundance in Control', y = 'Power (global)')
```


```{r, echo=FALSE}
loec <- function(z){
  loecs <- ldply(z, function(w) c(lm = w$loeclm, glm = w$loecglm))
  out <- apply(loecs, 2, function(x) sum(x == 2))
  return(out)
}
loecs <- ldply(res, loec)
loecs$muc <- todo$ctrl
loecs$N <- todo$N

loecsm <- melt(loecs, id.vars = c('muc', 'N'))
loecsm$value <- loecsm$value/nsims

ggplot(loecsm) +
  geom_line(aes(y = value, x = muc, col = variable)) +
  coord_trans(xtrans = 'log10') +
  scale_x_continuous(breaks = round(unique(todo$ctrl), 0)) +
  facet_wrap(~N) + 
  theme_bw() +
  labs(x = 'mean Abundance in Control', y = 'Proportion correct LOEC')
```

## Simulations based on real data

# Diskussion
## Simulation scenarious
## Simulations based on real data
## Conclusions

## Tipps
(Or move up to introduction?)
### Check distribution
#### Plot mean variance relationship
